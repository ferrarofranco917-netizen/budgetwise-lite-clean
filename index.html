<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <title>BudgetWise ‚Äî Stipendio a Stipendio</title>
  <link rel="icon" href="icon-192.png">
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      --bg:#0b1220; --card:#111827; --muted:#9ca3af; --text:#e5e7eb;
      --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 600px at 20% 0%, #172554 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:18px}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:14px}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, #22c55e, #3b82f6);
      display:grid; place-items:center; font-weight:900; color:#071018;
      box-shadow:0 10px 30px rgba(34,197,94,.2);
    }
    h1{font-size:18px; margin:0}
    .sub{color:var(--muted); font-size:13px}

    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: rgba(17,24,39,.92);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}

    label{display:block; font-size:12px; color:var(--muted); margin:8px 0 6px}
    input, select, button{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#0b1220;
      color:var(--text);
      outline:none;
    }
    input[type="date"], input[type="month"]{padding:10px 12px}
    input[type="checkbox"]{width:auto; transform: scale(1.1);}
    button{
      cursor:pointer; border:none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color:#06110a; font-weight:900;
    }
    button.secondary{background:#0b1220; border:1px solid var(--border); color:var(--text); font-weight:800}
    button.danger{background: linear-gradient(135deg, #ef4444, #b91c1c); color:#150707}

    .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:#0b1220; color:var(--muted); font-size:12px}
    .divider{height:1px; background:var(--border); margin:12px 0}
    .muted{color:var(--muted)}
    .note{font-size:13px; line-height:1.45}

    .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px}
    @media (max-width:520px){ .kpis{grid-template-columns:1fr} }
    .kpi{padding:12px; border-radius:16px; border:1px solid var(--border); background:#0b1220}
    .kpi .t{color:var(--muted); font-size:12px}
    .kpi .v{font-size:18px; font-weight:1000; margin-top:4px}

    .bar{height:10px; background:#0b1220; border:1px solid var(--border); border-radius:999px; overflow:hidden; margin-top:10px}
    .bar>div{height:100%; width:0%}

    .list{margin-top:10px}
    .item{
      display:grid; grid-template-columns: 1fr auto; gap:10px;
      padding:12px; border-radius:16px; border:1px solid var(--border); background:#0b1220;
      margin-top:10px;
    }
    .item .meta{color:var(--muted); font-size:12px; margin-top:4px}
    .item .amt{font-weight:1000}
    .item .actions{display:flex; gap:8px; align-items:start}
    .mini{padding:8px 10px; border-radius:12px; font-size:12px}

    canvas{width:100%; height:220px; background:#0b1220; border:1px solid var(--border); border-radius:16px;}

    .toast{
      display:none; position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; max-width:92vw;
      background:#0b1220; border:1px solid var(--border);
      padding:10px 12px; border-radius:999px; color:var(--text);
      box-shadow:0 12px 35px rgba(0,0,0,.35);
    }
    .toast.show{display:block}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">‚Ç¨</div>
      <div>
        <h1>BudgetWise ‚Äî Stipendio a Stipendio</h1>
        <div class="sub">Grafico ¬∑ storico ¬∑ soglia X ¬∑ vacanza ¬∑ obiettivo risparmio ¬∑ prudente ¬∑ backup</div>
      </div>
    </div>

    <div class="row" style="max-width:640px; width:100%">
      <div>
        <label>Giorno (per inserire spese variabili)</label>
        <input id="day" type="date" />
      </div>
      <div>
        <label>Data stipendio (inizio periodo)</label>
        <input id="payday" type="date" />
      </div>
      <div style="align-self:end">
        <button id="setPayday" class="secondary">Usa come inizio periodo</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- SINISTRA -->
    <div class="card">
      <div class="pill">üìÖ Riepilogo periodo</div>

      <div class="kpis">
        <div class="kpi">
          <div class="t">Budget giornaliero</div>
          <div class="v" id="kDaily">0,00 ‚Ç¨</div>
        </div>
        <div class="kpi">
          <div class="t">Rimanenza</div>
          <div class="v" id="kRemain">0,00 ‚Ç¨</div>
        </div>
        <div class="kpi">
          <div class="t">Giorni rimanenti</div>
          <div class="v" id="kDays">0</div>
        </div>
      </div>

      <div class="bar"><div id="barFill"></div></div>
      <p class="muted note" id="kExplain" style="margin:10px 0 0"></p>

      <!-- ‚úÖ SPOSTATE IN ALTO: SPESE VARIABILI -->
      <div class="divider"></div>

      <div class="pill">üßæ Spese variabili (giorno scelto)</div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Importo (‚Ç¨)</label>
          <input id="v_amount" type="text" inputmode="decimal" placeholder="es. 4,50" />
        </div>
        <div>
          <label>Categoria (menu)</label>
          <select id="v_cat">
            <option value="Ristorante">Ristorante</option>
            <option value="Spesa (supermercato)">Spesa (supermercato)</option>
            <option value="Casa">Casa</option>
            <option value="Moto">Moto</option>
            <option value="Macchina">Macchina</option>
            <option value="Benzina">Benzina</option>
            <option value="Gas">Gas</option>
            <option value="Luce">Luce</option>
            <option value="Acqua">Acqua</option>
            <option value="TV/Streaming">TV / Streaming</option>
            <option value="Telefono/Internet">Telefono / Internet</option>
            <option value="Farmacia">Farmacia</option>
            <option value="Svago">Svago</option>
            <option value="Altro">Altro</option>
          </select>
        </div>
      </div>

      <label>Nota</label>
      <input id="v_note" type="text" placeholder="es. cena / pane / manutenzione" />

      <div class="row" style="margin-top:10px">
        <button id="v_add">Aggiungi spesa variabile</button>
        <button id="v_export" class="secondary">Esporta variabili CSV</button>
      </div>

      <div class="list" id="v_list"></div>

      <div class="divider"></div>

      <div class="pill">üìä Grafico spese per categoria</div>
      <p class="muted note" style="margin:10px 0 0">Spese variabili nel periodo (fino al giorno selezionato).</p>
      <div style="margin-top:10px">
        <canvas id="catChart" width="900" height="260"></canvas>
      </div>

      <div class="divider"></div>

      <div class="pill">üè¶ Entrate del periodo</div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Nome</label>
          <input id="i_name" type="text" placeholder="es. Stipendio" />
        </div>
        <div>
          <label>Importo (‚Ç¨)</label>
          <input id="i_amount" type="text" inputmode="decimal" placeholder="es. 3000 oppure 3000,50" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="i_add">Aggiungi entrata</button>
        <button id="i_export" class="secondary">Esporta entrate CSV</button>
      </div>

      <div class="list" id="i_list"></div>

      <div class="divider"></div>

      <div class="pill">üíº Risparmio (fuori budget)</div>
      <p class="muted note" style="margin:10px 0 0">Soldi ‚Äúda parte‚Äù fissi: NON entrano nel budget.</p>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Risparmio fuori budget (‚Ç¨)</label>
          <input id="savings" type="text" inputmode="decimal" placeholder="es. 2000" />
        </div>
        <div style="align-self:end">
          <button id="saveSavings" class="secondary">Salva</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="pill">üéØ Risparmio automatico obiettivo</div>
      <p class="muted note" style="margin:10px 0 0">
        Imposti percentuale e obiettivo. Premi ‚ÄúApplica‚Äù per mettere da parte (fuori budget) una quota delle entrate di questo periodo.
      </p>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Percentuale su entrate (%)</label>
          <input id="autoSavePct" type="text" inputmode="decimal" placeholder="es. 10" />
        </div>
        <div>
          <label>Totale gi√† risparmiato (‚Ç¨)</label>
          <input id="goalSaved" type="text" inputmode="decimal" placeholder="es. 500" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Obiettivo finale (‚Ç¨)</label>
          <input id="goalTarget" type="text" inputmode="decimal" placeholder="es. 5000" />
        </div>
        <div style="align-self:end">
          <button id="applyAutoSave" class="secondary">Applica al periodo</button>
        </div>
      </div>
      <p class="muted note" id="goalExplain" style="margin:10px 0 0"></p>

      <div class="divider"></div>

      <div class="pill">üìå Spese fisse mensili (con scadenza)</div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Nome</label>
          <input id="f_name" type="text" placeholder="es. Netflix" />
        </div>
        <div>
          <label>Categoria</label>
          <select id="f_cat">
            <option value="Casa">Casa</option>
            <option value="Gas">Gas</option>
            <option value="Luce">Luce</option>
            <option value="Acqua">Acqua</option>
            <option value="TV/Streaming">TV / Streaming</option>
            <option value="Telefono/Internet">Telefono / Internet</option>
            <option value="Moto">Moto</option>
            <option value="Macchina">Macchina</option>
            <option value="Assicurazione">Assicurazione</option>
            <option value="Altro">Altro</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Importo (‚Ç¨)</label>
          <input id="f_amount" type="text" inputmode="decimal" placeholder="es. 12,99" />
        </div>
        <div>
          <label>Giorno addebito (1-31)</label>
          <input id="f_debitDay" type="number" min="1" max="31" placeholder="es. 10" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Mese inizio</label>
          <input id="f_startMonth" type="month" />
        </div>
        <div>
          <label>Mese scadenza (opzionale)</label>
          <input id="f_endMonth" type="month" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="f_add">Aggiungi spesa fissa</button>
        <button id="f_export" class="secondary">Esporta fisse CSV</button>
      </div>

      <div class="list" id="f_list"></div>
    </div>

    <!-- DESTRA -->
    <div class="card">
      <div class="pill">‚öôÔ∏è Impostazioni</div>

      <label>Modalit√† budget</label>
      <select id="budgetMode">
        <option value="simple">Semplice</option>
        <option value="prudent">Prudente (toglie gi√† le fisse future)</option>
      </select>

      <label style="margin-top:10px">Avvisi</label>
      <select id="alertMode">
        <option value="on">Mostra avviso se budget giornaliero &lt; 0</option>
        <option value="off">Nessun avviso</option>
      </select>

      <div class="divider"></div>

      <div class="pill">üîî Avviso soglia X ‚Ç¨</div>
      <p class="muted note" style="margin:10px 0 0">Avvisa quando le spese variabili del periodo (fino a oggi) superano X ‚Ç¨.</p>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Soglia X (‚Ç¨)</label>
          <input id="alertX" type="text" inputmode="decimal" placeholder="es. 1200" />
        </div>
        <div style="align-self:end">
          <button id="saveAlertX" class="secondary">Salva soglia</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="pill">üèñ Modalit√† vacanza</div>
      <div class="inline" style="margin-top:10px">
        <input id="vacEnabled" type="checkbox" />
        <span class="muted">Attiva vacanza (date + budget separato)</span>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Inizio vacanza</label>
          <input id="vacStart" type="date" />
        </div>
        <div>
          <label>Fine vacanza</label>
          <input id="vacEnd" type="date" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Budget totale vacanza (‚Ç¨)</label>
          <input id="vacBudget" type="text" inputmode="decimal" placeholder="es. 600" />
        </div>
        <div style="align-self:end">
          <button id="saveVac" class="secondary">Salva vacanza</button>
        </div>
      </div>

      <p class="muted note" id="vacExplain" style="margin:10px 0 0"></p>

      <div class="divider"></div>

      <div class="pill">üïò Storico periodi</div>
      <p class="muted note" style="margin:10px 0 0">Seleziona un periodo (data stipendio) e aprilo.</p>
      <label>Seleziona periodo (data stipendio)</label>
      <select id="periodSelect"></select>
      <div class="row" style="margin-top:10px">
        <button id="goPeriod" class="secondary">Apri periodo</button>
        <button id="newPeriod" class="secondary">Nuovo periodo = oggi</button>
      </div>

      <div class="divider"></div>

      <div class="pill">üßπ Reset</div>
      <p class="muted note" style="margin:10px 0 0">Cancella solo le spese variabili del giorno selezionato.</p>
      <button id="resetDay" class="danger" style="margin-top:10px">Azzera spese variabili del giorno</button>

      <div class="divider"></div>

      <div class="pill">üíæ Backup dati</div>
      <button id="exportBackup" class="secondary" style="margin-top:10px">üì§ Esporta backup</button>
      <input id="importFile" type="file" accept=".json" style="display:none" />
      <button id="importBackup" class="secondary" style="margin-top:10px">üì• Importa backup</button>

      <!-- [GC] aggiunta Google Calendar -->
      <div class="divider"></div>
      <div class="pill">üìÖ Google Calendar</div>
      <p class="muted note" style="margin:10px 0 0">Crea un file .ics con spese variabili + fisse del periodo. Poi lo importi in Google Calendar.</p>
      <button id="exportICS" class="secondary" style="margin-top:10px">üì§ Esporta Calendario (.ics)</button>
      <!-- [/GC] -->
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // ‚úÖ NON CAMBIARE: cos√¨ non perdi i dati gi√† inseriti
  const KEY = "bw_paycycle_v2_savings";

  const state = load();
  state.settings = state.settings || {};
  state.settings.alertMode = state.settings.alertMode ?? "on";
  state.settings.budgetMode = state.settings.budgetMode || "simple";
  state.settings.alertX = state.settings.alertX ?? 0;

  state.vac = state.vac || { enabled:false, start:null, end:null, budget:0 };
  state.goal = state.goal || { pct: 0, saved: 0, target: 0, perPeriod: {} };

  const today = new Date();

  // [DAY-AUTO] gestione "Giorno": auto oggi all'apertura, poi non sovrascrive se cambi a mano
  let dayPinnedByUser = false;
  let lastAutoDayISO = null;
  let suppressPin = false;

  // [DAY-AUTO] all'apertura: mette oggi
  setDayAuto(toISODate(today));

  state.activePayday = state.activePayday || toISODate(today);
  $("payday").value = state.activePayday;

  $("f_startMonth").value = monthKey(parseISO(state.activePayday));

  // init settings UI
  $("alertMode").value = state.settings.alertMode;
  $("budgetMode").value = state.settings.budgetMode;
  $("alertX").value = state.settings.alertX ? String(state.settings.alertX).replace(".", ",") : "";

  $("savings").value = (state.savings ?? 0) ? String(state.savings).replace(".", ",") : "";

  $("vacEnabled").checked = !!state.vac.enabled;
  $("vacStart").value = state.vac.start || "";
  $("vacEnd").value = state.vac.end || "";
  $("vacBudget").value = state.vac.budget ? String(state.vac.budget).replace(".", ",") : "";

  $("autoSavePct").value = state.goal.pct ? String(state.goal.pct).replace(".", ",") : "";
  $("goalSaved").value = state.goal.saved ? String(state.goal.saved).replace(".", ",") : "";
  $("goalTarget").value = state.goal.target ? String(state.goal.target).replace(".", ",") : "";

  // events
  $("day").addEventListener("change", () => {
    // [DAY-AUTO] se lo cambi tu a mano, da qui in poi non lo sovrascriviamo mentre l'app resta aperta
    if (!suppressPin) dayPinnedByUser = true;
    render();
  });

  // [DAY-AUTO] quando torni sull'app: aggiorna a oggi SOLO se non stavi lavorando su un giorno manuale
  window.addEventListener("focus", autoUpdateDayIfAllowed);
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") autoUpdateDayIfAllowed();
  });

  $("setPayday").addEventListener("click", () => {
    const p = $("payday").value;
    if (!p) return toast("Scegli una data stipendio.");
    state.activePayday = p;
    $("f_startMonth").value = monthKey(parseISO(p));
    save(state);
    toast("Periodo aggiornato ‚úÖ");
    render();
  });

  $("alertMode").addEventListener("change", () => {
    state.settings.alertMode = $("alertMode").value;
    save(state);
  });

  $("budgetMode").addEventListener("change", () => {
    state.settings.budgetMode = $("budgetMode").value;
    save(state);
    render();
  });

  $("saveAlertX").addEventListener("click", () => {
    const v = num($("alertX").value);
    if (!isFinite(v) || v < 0) return toast("Soglia non valida (>=0).");
    state.settings.alertX = round2(v);
    save(state);
    toast("Soglia salvata ‚úÖ");
    render();
  });

  $("saveSavings").addEventListener("click", () => {
    const v = num($("savings").value);
    if (!isFinite(v) || v < 0) return toast("Risparmio non valido (>=0).");
    state.savings = round2(v);
    save(state);
    toast("Risparmio salvato ‚úÖ");
    render();
  });

  $("saveVac").addEventListener("click", () => {
    state.vac.enabled = $("vacEnabled").checked;
    state.vac.start = $("vacStart").value || null;
    state.vac.end = $("vacEnd").value || null;
    const b = num($("vacBudget").value);
    state.vac.budget = (isFinite(b) && b >= 0) ? round2(b) : 0;

    if (state.vac.enabled) {
      if (!state.vac.start || !state.vac.end) return toast("Metti inizio e fine vacanza.");
      if (state.vac.end < state.vac.start) return toast("Fine vacanza non pu√≤ essere prima dell'inizio.");
    }
    save(state);
    toast("Vacanza salvata ‚úÖ");
    render();
  });

  $("applyAutoSave").addEventListener("click", () => {
    const pct = num($("autoSavePct").value);
    const target = num($("goalTarget").value);
    const saved = num($("goalSaved").value);

    if (!isFinite(pct) || pct < 0 || pct > 100) return toast("Percentuale non valida (0-100).");
    if (!isFinite(target) || target < 0) return toast("Obiettivo non valido (>=0).");
    if (!isFinite(saved) || saved < 0) return toast("Totale risparmiato non valido (>=0).");

    state.goal.pct = round2(pct);
    state.goal.target = round2(target);
    state.goal.saved = round2(saved);

    const period = periodKey(state.activePayday);
    const inc = round2(incomesForPeriod(period).reduce((s,i)=>s+i.amount,0));
    const auto = round2(inc * (state.goal.pct / 100));

    state.goal.perPeriod = state.goal.perPeriod || {};
    state.goal.perPeriod[period] = auto;
    state.goal.saved = round2(state.goal.saved + auto);

    save(state);
    toast(`Risparmio applicato: ${eur(auto)}`);
    render();
  });

  $("goPeriod").addEventListener("click", () => {
    const p = $("periodSelect").value;
    if (!p) return;
    state.activePayday = p;
    $("payday").value = p;
    $("f_startMonth").value = monthKey(parseISO(p));
    save(state);
    toast("Periodo aperto ‚úÖ");
    render();
  });

  $("newPeriod").addEventListener("click", () => {
    const p = toISODate(new Date());
    state.activePayday = p;
    $("payday").value = p;
    $("f_startMonth").value = monthKey(parseISO(p));
    save(state);
    toast("Nuovo periodo (oggi) ‚úÖ");
    render();
  });

  $("i_add").addEventListener("click", () => {
    const period = periodKey(state.activePayday);
    const name = ($("i_name").value.trim() || "Entrata");
    const amount = num($("i_amount").value);
    if (!isFinite(amount) || amount <= 0) return toast("Importo entrata non valido (>0).");

    state.incomes.push({ id: idgen(), period, name, amount: round2(amount) });
    save(state);

    $("i_name").value = "";
    $("i_amount").value = "";
    render();
  });

  $("f_add").addEventListener("click", () => {
    const name = ($("f_name").value.trim() || "Spesa fissa");
    const cat = $("f_cat").value;
    const amount = num($("f_amount").value);
    const debitDay = parseInt($("f_debitDay").value, 10);
    const startMonth = $("f_startMonth").value;
    const endMonth = $("f_endMonth").value;

    if (!isFinite(amount) || amount <= 0) return toast("Importo fisso non valido (>0).");
    if (!isFinite(debitDay) || debitDay < 1 || debitDay > 31) return toast("Giorno addebito deve essere 1-31.");
    if (!startMonth) return toast("Scegli un mese di inizio.");
    if (endMonth && endMonth < startMonth) return toast("La scadenza non pu√≤ essere prima dell'inizio.");

    state.fixedMonthly.push({
      id: idgen(), name, cat,
      amount: round2(amount),
      debitDay,
      startMonth,
      endMonth: endMonth || null
    });
    save(state);

    $("f_name").value = "";
    $("f_amount").value = "";
    $("f_debitDay").value = "";
    $("f_endMonth").value = "";
    render();
  });

  $("v_add").addEventListener("click", () => {
    const day = $("day").value;
    const amount = num($("v_amount").value);
    const cat = $("v_cat").value;
    const note = $("v_note").value.trim();

    if (!day) return;
    if (!isFinite(amount) || amount <= 0) return toast("Importo spesa non valido (>0).");

    state.expenses.push({ id: idgen(), date: day, amount: round2(amount), cat, note });
    save(state);

    $("v_amount").value = "";
    $("v_note").value = "";
    render();
  });

  $("resetDay").addEventListener("click", () => {
    const day = $("day").value;
    const before = state.expenses.length;
    state.expenses = state.expenses.filter(e => e.date !== day);
    save(state);
    toast(before === state.expenses.length ? "Niente da cancellare." : "Giorno azzerato üßπ");
    render();
  });

  $("v_export").addEventListener("click", () => exportCSVVariabili());
  $("i_export").addEventListener("click", () => exportCSVEntrate());
  $("f_export").addEventListener("click", () => exportCSVFisse());

  // -------- BACKUP / RIPRISTINO --------
  $("exportBackup").addEventListener("click", () => {
    const data = localStorage.getItem(KEY);
    if (!data) return toast("Nessun dato da esportare.");
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "budget-backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Backup esportato üì§");
  });

  $("importBackup").addEventListener("click", () => {
    $("importFile").click();
  });

  $("importFile").addEventListener("change", (ev) => {
    const file = ev.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        JSON.parse(reader.result);
        localStorage.setItem(KEY, reader.result);
        toast("Backup importato ‚úÖ");
        setTimeout(()=>location.reload(), 800);
      }catch{
        toast("File non valido ‚ùå");
      }
    };
    reader.readAsText(file);
  });

  // [GC] Export .ics per Google Calendar (variabili + fisse nel periodo)
  $("exportICS").addEventListener("click", () => exportICS());
  // [/GC]

  // PWA Offline (service worker)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(() => {});
  }

  render();

  // ------------------ CALCOLO PERIODO ------------------
  function calcPeriod(dayISO){
    const paydayISO = state.activePayday;
    const period = periodKey(paydayISO);
    const { start, end } = periodFromPayday(paydayISO);

    const inc = round2(incomesForPeriod(period).reduce((s,i)=>s+i.amount,0));

    // Fisse: conteggiate se attive e il loro addebito cade nel periodo
    let fixTotal = 0;
    state.fixedMonthly.forEach(f => {
      const m1 = monthKey(start);
      const m2 = monthKey(addDays(start, 20));
      const active = fixedActiveInMonth(f, m1) || fixedActiveInMonth(f, m2);
      if (!active) return;
      const debit = fixedDebitDateForPeriod(f, start);
      if (debit >= start && debit <= end) fixTotal += f.amount;
    });
    fixTotal = round2(fixTotal);

    // Risparmi
    const savings = round2(Number(state.savings || 0));
    const autoSaveThisPeriod = round2(Number((state.goal?.perPeriod || {})[period] || 0));

    const budgetPeriod = round2(inc - savings - autoSaveThisPeriod - fixTotal);

    // Variabili nel periodo fino al giorno selezionato
    const varSpent = round2(
      state.expenses
        .filter(e => inPeriod(e.date, start, end) && e.date <= dayISO)
        .reduce((s,e)=>s+e.amount,0)
    );

    // Prudente: toglie gi√† le fisse future (addebito > giorno selezionato)
    let fixFuture = 0;
    if ((state.settings.budgetMode || "simple") === "prudent") {
      const day = parseISO(dayISO);
      state.fixedMonthly.forEach(f => {
        const m1 = monthKey(start);
        const m2 = monthKey(addDays(start, 20));
        const active = fixedActiveInMonth(f, m1) || fixedActiveInMonth(f, m2);
        if (!active) return;

        const debit = fixedDebitDateForPeriod(f, start);
        if (debit < start || debit > end) return;

        if (debit > day) fixFuture += f.amount;
      });
      fixFuture = round2(fixFuture);
    }

    // Vacanza: se il giorno √® dentro vacanza, mostro budget vacanza separato
    const vac = state.vac || { enabled:false };
    const dayD = parseISO(dayISO);
    const inVacation = !!(vac.enabled && vac.start && vac.end && (dayISO >= vac.start && dayISO <= vac.end));

    let vacTotal = 0, vacSpent = 0, vacDaysLeft = 0, vacDaily = 0;
    if (vac.enabled && vac.start && vac.end) {
      const vacStart = maxDate(parseISO(vac.start), start);
      const vacEnd = minDate(parseISO(vac.end), end);
      if (vacEnd >= vacStart) {
        vacTotal = round2(Number(vac.budget || 0));
        const vacUntil = minDate(dayD, vacEnd);
        if (vacUntil >= vacStart) {
          vacSpent = round2(
            state.expenses
              .filter(e => {
                const d = parseISO(e.date);
                return d >= vacStart && d <= vacUntil;
              })
              .reduce((s,e)=>s+e.amount,0)
          );
        }
        if (dayD <= vacEnd) {
          const startCount = maxDate(dayD, vacStart);
          vacDaysLeft = Math.max(0, daysBetweenInclusive(startCount, vacEnd));
          vacDaily = vacDaysLeft > 0 ? round2((vacTotal - vacSpent) / vacDaysLeft) : 0;
        }
      }
    }

    const remaining = round2(budgetPeriod - fixFuture - varSpent);

    const daysLeft = Math.max(1, daysBetweenInclusive(dayD, end));
    const daily = round2(remaining / daysLeft);

    return {
      start, end, period,
      inc, fixTotal, savings, autoSaveThisPeriod, budgetPeriod,
      varSpent, fixFuture, remaining, daysLeft, daily,
      inVacation, vacTotal, vacSpent, vacDaysLeft, vacDaily
    };
  }

  // ------------------ RENDER ------------------
  function render(){
    const dayISO = $("day").value;
    const p = calcPeriod(dayISO);

    // KPI (se vacanza attiva nel giorno)
    if (p.inVacation && p.vacDaysLeft > 0) {
      $("kDaily").textContent = eur(p.vacDaily);
      $("kRemain").textContent = eur(round2(p.vacTotal - p.vacSpent));
      $("kDays").textContent = String(p.vacDaysLeft);
    } else {
      $("kDaily").textContent = eur(p.daily);
      $("kRemain").textContent = eur(p.remaining);
      $("kDays").textContent = String(p.daysLeft);
    }

    // progress bar su budgetPeriod
    const used = (p.budgetPeriod === 0) ? 0 : Math.min(200, Math.round((p.varSpent / Math.max(1, p.budgetPeriod)) * 100));
    const fill = $("barFill");
    fill.style.width = Math.min(100, used) + "%";
    fill.style.background =
      (used < 80) ? "linear-gradient(135deg, #22c55e, #16a34a)" :
      (used <= 100) ? "linear-gradient(135deg, #f59e0b, #d97706)" :
      "linear-gradient(135deg, #ef4444, #b91c1c)";

    const sISO = toISODate(p.start);
    const eISO = toISODate(p.end);
    const mode = (state.settings.budgetMode || "simple") === "prudent" ? "Prudente" : "Semplice";

    const vacNote = (p.inVacation && p.vacDaysLeft > 0)
      ? ` | üèñ Vacanza: residuo ${eur(round2(p.vacTotal - p.vacSpent))} / ${p.vacDaysLeft} giorni`
      : "";

    $("kExplain").textContent =
      `(${mode}) Periodo ${sISO} ‚Üí ${eISO}. Entrate ${eur(p.inc)} ‚àí Risparmio ${eur(p.savings)} ‚àí Auto-risparmio ${eur(p.autoSaveThisPeriod)} ‚àí Fisse ${eur(p.fixTotal)} = Budget ${eur(p.budgetPeriod)}.
       Variabili (fino a ${dayISO}) ${eur(p.varSpent)}${(p.fixFuture>0?` ‚àí Fisse future ${eur(p.fixFuture)}`:"")} ‚Üí Rimanenza ${eur(p.remaining)} ‚Üí Budget giornaliero ${eur(p.daily)}${vacNote}.`;

    // vac explain
    const vac = state.vac || { enabled:false };
    $("vacExplain").textContent =
      (vac.enabled && vac.start && vac.end)
        ? `Vacanza: ${vac.start} ‚Üí ${vac.end}, budget totale ${eur(vac.budget||0)}.`
        : "Vacanza disattivata.";

    // goal explain
    const pct = Number(state.goal?.pct || 0);
    const saved = Number(state.goal?.saved || 0);
    const target = Number(state.goal?.target || 0);
    if (target > 0) {
      const perc = Math.min(100, Math.round((saved / target) * 100));
      $("goalExplain").textContent = `Obiettivo: ${eur(target)} ¬∑ Risparmiato: ${eur(saved)} (${perc}%). Percentuale auto: ${pct}% (premi ‚ÄúApplica al periodo‚Äù).`;
    } else {
      $("goalExplain").textContent = `Imposta un obiettivo se vuoi. Percentuale auto: ${pct}%.`;
    }

    // storico periodi
    renderPeriodSelect();

    // liste
    renderIncomes(p.period);
    renderFixed(p.start, p.end);
    renderDayExpenses(dayISO);

    // grafico
    drawCategoryChart(p.start, p.end, dayISO);

    // avvisi (sempre)
    maybeAlert(p);
    maybeAlertX(p);
  }

  function renderPeriodSelect(){
    const sel = $("periodSelect");
    const current = state.activePayday;

    // periodi = quelli che compaiono nelle entrate + quelli che compaiono in autosave + current
    const set = new Set();
    state.incomes.forEach(i => set.add(i.period));
    Object.keys(state.goal?.perPeriod || {}).forEach(k => set.add(k));
    if (current) set.add(current);

    const periods = Array.from(set).filter(Boolean).sort().reverse();

    sel.innerHTML = "";
    periods.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      if (p === current) opt.selected = true;
      sel.appendChild(opt);
    });
  }

  // ------------------ GRAFICO CATEGORIE (canvas) ------------------
  function drawCategoryChart(periodStart, periodEnd, dayISO){
    const canvas = $("catChart");
    const ctx = canvas.getContext("2d");

    // resize per retina
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(300, Math.floor(rect.width));
    const h = Math.max(220, Math.floor(rect.height));
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    const totals = {};
    state.expenses.forEach(e => {
      const d = parseISO(e.date);
      if (d < periodStart || d > periodEnd) return;
      if (e.date > dayISO) return;
      totals[e.cat] = (totals[e.cat] || 0) + Number(e.amount || 0);
    });

    const entries = Object.entries(totals)
      .map(([k,v]) => [k, round2(v)])
      .sort((a,b)=>b[1]-a[1])
      .slice(0, 10);

    ctx.clearRect(0,0,w,h);

    if (entries.length === 0){
      ctx.fillStyle = "#9ca3af";
      ctx.font = "14px system-ui";
      ctx.fillText("Nessuna spesa nel periodo (fino al giorno selezionato).", 14, 30);
      return;
    }

    const padL = 16, padR = 12, padT = 18;
    const chartW = w - padL - padR;
    const maxV = Math.max(...entries.map(x => x[1]), 1);

    ctx.fillStyle = "#e5e7eb";
    ctx.font = "12px system-ui";
    ctx.fillText("Top categorie (spese variabili)", padL, padT);

    const barTop = padT + 14;
    const barH = Math.max(12, Math.floor((h - barTop - 16) / entries.length) - 6);

    entries.forEach((it, idx) => {
      const [cat, val] = it;
      const y = barTop + idx * (barH + 6);
      const bw = Math.max(6, Math.floor((val / maxV) * (chartW * 0.62)));

      const grad = ctx.createLinearGradient(padL, 0, padL + bw, 0);
      grad.addColorStop(0, "#22c55e");
      grad.addColorStop(1, "#3b82f6");
      ctx.fillStyle = grad;
      roundRect(ctx, padL, y, bw, barH, 10, true, false);

      ctx.fillStyle = "#e5e7eb";
      ctx.font = "12px system-ui";
      ctx.fillText(cat, padL + bw + 10, y + barH - 2);

      ctx.fillStyle = "#9ca3af";
      ctx.font = "12px system-ui";
      ctx.fillText(eur(val), padL + bw + 10, y + barH + 14);
    });
  }

  function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
    if (typeof radius === 'number') radius = {tl: radius, tr: radius, br: radius, bl: radius};
    ctx.beginPath();
    ctx.moveTo(x + radius.tl, y);
    ctx.lineTo(x + width - radius.tr, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
    ctx.lineTo(x + width, y + height - radius.br);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
    ctx.lineTo(x + radius.bl, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
    ctx.lineTo(x, y + radius.tl);
    ctx.quadraticCurveTo(x, y, x + radius.tl, y);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }

  // ------------------ LISTE ------------------
  function incomesForPeriod(period){
    return state.incomes.filter(i => i.period === period);
  }

  function renderIncomes(period){
    const box = $("i_list");
    box.innerHTML = "";
    const items = incomesForPeriod(period).slice().sort((a,b)=>a.name.localeCompare(b.name));

    if (items.length === 0){
      box.innerHTML = `<p class="muted">Nessuna entrata in questo periodo.</p>`;
      return;
    }

    items.forEach(i => {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div>
          <div><strong>${escapeHtml(i.name)}</strong> <span class="muted">¬∑ periodo ${escapeHtml(i.period)}</span></div>
          <div class="meta">Entrata del periodo</div>
        </div>
        <div class="actions">
          <div class="amt">${eur(i.amount)}</div>
          <button class="secondary mini" data-idel="${i.id}">Elimina</button>
        </div>
      `;
      box.appendChild(el);
    });

    box.querySelectorAll("[data-idel]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-idel");
        state.incomes = state.incomes.filter(x => x.id !== id);
        save(state);
        toast("Entrata eliminata.");
        render();
      });
    });
  }

  function renderFixed(periodStart, periodEnd){
    const box = $("f_list");
    box.innerHTML = "";
    const items = state.fixedMonthly.slice().sort((a,b)=>a.debitDay-b.debitDay);

    if (items.length === 0){
      box.innerHTML = `<p class="muted">Nessuna spesa fissa salvata.</p>`;
      return;
    }

    items.forEach(f => {
      const active = `${f.startMonth}${f.endMonth ? " ‚Üí " + f.endMonth : ""}`;
      const debit = fixedDebitDateForPeriod(f, periodStart);

      const m1 = monthKey(periodStart);
      const m2 = monthKey(addDays(periodStart, 20));
      const activeInPeriod = fixedActiveInMonth(f, m1) || fixedActiveInMonth(f, m2);

      const willCount = (debit >= periodStart && debit <= periodEnd) && activeInPeriod;

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div>
          <div><strong>${escapeHtml(f.name)}</strong> <span class="muted">¬∑ ${escapeHtml(f.cat)}</span></div>
          <div class="meta">
            Addebito giorno ${f.debitDay} (${toISODate(debit)}) ¬∑ Attiva: ${escapeHtml(active)} ¬∑
            ${willCount ? "‚úÖ conteggiata nel periodo" : "‚Äî non conteggiata nel periodo"}
          </div>
        </div>
        <div class="actions">
          <div class="amt">${eur(f.amount)}</div>
          <button class="secondary mini" data-fdel="${f.id}">Elimina</button>
        </div>
      `;
      box.appendChild(el);
    });

    box.querySelectorAll("[data-fdel]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-fdel");
        state.fixedMonthly = state.fixedMonthly.filter(x => x.id !== id);
        save(state);
        toast("Spesa fissa eliminata.");
        render();
      });
    });
  }

  function renderDayExpenses(dayISO){
    const box = $("v_list");
    box.innerHTML = "";
    const items = state.expenses
      .filter(e => e.date === dayISO)
      .slice()
      .sort((a,b)=> String(b.id).localeCompare(String(a.id)));

    if (items.length === 0){
      box.innerHTML = `<p class="muted">Nessuna spesa variabile in questo giorno.</p>`;
      return;
    }

    items.forEach(e => {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div>
          <div><strong>${escapeHtml(e.cat)}</strong> <span class="muted">¬∑ ${escapeHtml(e.date)}</span></div>
          <div class="meta">${escapeHtml(e.note || "‚Äî")}</div>
        </div>
        <div class="actions">
          <div class="amt">${eur(e.amount)}</div>
          <button class="secondary mini" data-vdel="${e.id}">Elimina</button>
        </div>
      `;
      box.appendChild(el);
    });

    box.querySelectorAll("[data-vdel]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-vdel");
        state.expenses = state.expenses.filter(x => x.id !== id);
        save(state);
        toast("Spesa eliminata.");
        render();
      });
    });
  }

  // ------------------ AVVISI ------------------
  function maybeAlert(p){
    if ((state.settings.alertMode ?? "on") === "off") return;
    if (!p.inVacation && p.daily < 0) toast("‚ö†Ô∏è Budget giornaliero sotto zero!");
    if (p.inVacation && p.vacDaysLeft > 0 && p.vacDaily < 0) toast("‚ö†Ô∏è Budget vacanza sotto zero!");
  }

  function maybeAlertX(p){
    const x = Number(state.settings.alertX || 0);
    if (!x || x <= 0) return;
    if (p.varSpent > x) toast(`üîî Superata soglia: ${eur(p.varSpent)} > ${eur(x)}`);
  }

  // ------------------ EXPORT CSV ------------------
  function exportCSVVariabili(){
    const rows = [["Data","Categoria","Importo","Nota"]];
    state.expenses
      .slice()
      .sort((a,b)=>a.date.localeCompare(b.date))
      .forEach(e => rows.push([e.date, e.cat, fmtCSVNum(e.amount), e.note ?? ""]));
    downloadCSV(rows, "spese-variabili.csv");
    toast("CSV variabili esportato üìÑ");
  }

  function exportCSVEntrate(){
    const rows = [["Periodo","Nome","Importo"]];
    state.incomes
      .slice()
      .sort((a,b)=>a.period.localeCompare(b.period))
      .forEach(i => rows.push([i.period, i.name, fmtCSVNum(i.amount)]));
    downloadCSV(rows, "entrate-periodo.csv");
    toast("CSV entrate esportato üìÑ");
  }

  function exportCSVFisse(){
    const rows = [["Nome","Categoria","Importo","GiornoAddebito","Inizio","Scadenza"]];
    state.fixedMonthly
      .slice()
      .sort((a,b)=>a.debitDay-b.debitDay)
      .forEach(f => rows.push([f.name, f.cat, fmtCSVNum(f.amount), String(f.debitDay), f.startMonth, f.endMonth ?? ""]));
    downloadCSV(rows, "spese-fisse-mensili.csv");
    toast("CSV fisse esportato üìÑ");
  }

  function downloadCSV(rows, filename){
    const csv = rows.map(r => r.map(cell => `"${String(cell).replaceAll('"','""')}"`).join(";")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ------------------ STORAGE ------------------
  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if (!raw) return {
        activePayday:null, incomes:[], fixedMonthly:[], expenses:[], savings:0,
        settings:{alertMode:"on", budgetMode:"simple", alertX:0},
        vac:{enabled:false, start:null, end:null, budget:0},
        goal:{pct:0, saved:0, target:0, perPeriod:{}}
      };
      const p = JSON.parse(raw);
      return {
        activePayday: p.activePayday || null,
        incomes: Array.isArray(p.incomes) ? p.incomes : [],
        fixedMonthly: Array.isArray(p.fixedMonthly) ? p.fixedMonthly : [],
        expenses: Array.isArray(p.expenses) ? p.expenses : [],
        savings: Number(p.savings || 0),
        settings: p.settings || {alertMode:"on", budgetMode:"simple", alertX:0},
        vac: p.vac || {enabled:false, start:null, end:null, budget:0},
        goal: p.goal || {pct:0, saved:0, target:0, perPeriod:{}}
      };
    } catch {
      return {
        activePayday:null, incomes:[], fixedMonthly:[], expenses:[], savings:0,
        settings:{alertMode:"on", budgetMode:"simple", alertX:0},
        vac:{enabled:false, start:null, end:null, budget:0},
        goal:{pct:0, saved:0, target:0, perPeriod:{}}
      };
    }
  }
  function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  // ------------------ UTILS ------------------
  // [DAY-AUTO]
  function setDayAuto(iso){
    suppressPin = true;
    $("day").value = iso;
    lastAutoDayISO = iso;
    suppressPin = false;
  }
  // [DAY-AUTO]
  function autoUpdateDayIfAllowed(){
    const todayISO = toISODate(new Date());
    const cur = $("day").value;

    // aggiorna SOLO se:
    // - non hai mai toccato la data manualmente
    // - oppure la data corrente √® l'ultima impostata automaticamente
    if (!dayPinnedByUser || cur === lastAutoDayISO) {
      if (cur !== todayISO) {
        setDayAuto(todayISO);
        render();
      }
    }
  }

  function num(v){
    const s = String(v ?? "").trim();
    if (!s) return NaN;
    if (s.includes(".") && s.includes(",")) return Number(s.replaceAll(".","").replace(",","."));  /* FIX: lasciato come nel tuo file */
    return Number(s.replace(",", "."));
  }
  function fmtCSVNum(n){ return String(Number(n)).replace(".", ","); }
  function round2(n){ return Math.round(n * 100) / 100; }
  function eur(n){
    const v = Number(n);
    return v.toLocaleString("it-IT",{minimumFractionDigits:2, maximumFractionDigits:2}) + " ‚Ç¨";
  }

  // ‚úÖ FIX DATA: niente UTC, data locale (Italia)
  function toISODate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function parseISO(iso){
    const [Y,M,D] = iso.split("-").map(Number);
    return new Date(Y, M-1, D);
  }
  function monthKey(d){
    const Y = d.getFullYear();
    const M = String(d.getMonth()+1).padStart(2,"0");
    return `${Y}-${M}`;
  }
  function addDays(d, n){
    const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    x.setDate(x.getDate() + n);
    return x;
  }
  function daysInMonth(y, m){ return new Date(y, m+1, 0).getDate(); }

  function periodFromPayday(paydayISO){
    const start = parseISO(paydayISO);
    const y = start.getFullYear();
    const m = start.getMonth();
    const d = start.getDate();

    const y2 = (m === 11) ? y+1 : y;
    const m2 = (m === 11) ? 0 : m+1;
    const d2 = Math.min(d, daysInMonth(y2, m2));
    const next = new Date(y2, m2, d2);

    const end = addDays(next, -1);
    return { start, end };
  }

  function inPeriod(dateISO, start, end){
    const d = parseISO(dateISO);
    return d >= start && d <= end;
  }

  function periodKey(paydayISO){ return paydayISO; }

  function fixedActiveInMonth(f, month){
    if (f.startMonth > month) return false;
    if (f.endMonth && month > f.endMonth) return false;
    return true;
  }

  function fixedDebitDateForPeriod(f, periodStart){
    const y = periodStart.getFullYear();
    const m = periodStart.getMonth();

    let d1 = new Date(y, m, Math.min(f.debitDay, daysInMonth(y, m)));
    if (d1 < periodStart) {
      const y2 = (m === 11) ? y+1 : y;
      const m2 = (m === 11) ? 0 : m+1;
      d1 = new Date(y2, m2, Math.min(f.debitDay, daysInMonth(y2, m2)));
    }
    return d1;
  }

  function idgen(){
    try{
      if (globalThis.crypto && typeof globalThis.crypto.randomUUID === "function") {
        return globalThis.crypto.randomUUID();
      }
    } catch(e){}
    return "id_" + Math.random().toString(16).slice(2) + Date.now();
  }

  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>el.classList.remove("show"), 2600);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function daysBetweenInclusive(a, b){
    const A = new Date(a.getFullYear(), a.getMonth(), a.getDate());
    const B = new Date(b.getFullYear(), b.getMonth(), b.getDate());
    return Math.floor((B - A) / (1000*60*60*24)) + 1;
  }
  function minDate(a,b){ return (a <= b) ? a : b; }
  function maxDate(a,b){ return (a >= b) ? a : b; }

  // ============================================================
  // [GC] GOOGLE CALENDAR (.ics) ‚Äî VARIABILI + FISSE NEL PERIODO
  // ============================================================
  function exportICS(){
    const dayISO = $("day").value;
    const p = calcPeriod(dayISO);
    const { start, end, period } = p;

    // Variabili: TUTTE nel periodo (non solo fino al giorno selezionato)
    const varItems = state.expenses
      .filter(e => inPeriod(e.date, start, end))
      .map(e => ({
        dateISO: e.date,
        title: `Spesa: ${e.cat} - ${eur(e.amount)}`,
        desc: e.note ? `Nota: ${e.note}` : ""
      }));

    // Fisse: una occorrenza nel periodo se cade nel periodo ed √® attiva
    const fixedItems = [];
    state.fixedMonthly.forEach(f => {
      const m1 = monthKey(start);
      const m2 = monthKey(addDays(start, 20));
      const active = fixedActiveInMonth(f, m1) || fixedActiveInMonth(f, m2);
      if (!active) return;

      const debit = fixedDebitDateForPeriod(f, start);
      if (debit < start || debit > end) return;

      fixedItems.push({
        dateISO: toISODate(debit),
        title: `Spesa fissa: ${f.name} - ${eur(f.amount)}`,
        desc: `Categoria: ${f.cat} ¬∑ Giorno addebito: ${f.debitDay}`
      });
    });

    const items = [...varItems, ...fixedItems].sort((a,b)=>a.dateISO.localeCompare(b.dateISO));
    if (items.length === 0) {
      toast("Nessuna spesa nel periodo da esportare.");
      return;
    }

    const ics = buildICS(items, period);
    downloadText(ics, `budgetwise-${period}.ics`, "text/calendar;charset=utf-8");
    toast("File .ics creato ‚úÖ Ora importalo in Google Calendar");
  }

  function buildICS(items, period){
    const lines = [];
    lines.push("BEGIN:VCALENDAR");
    lines.push("VERSION:2.0");
    lines.push("PRODID:-//BudgetWise//IT");
    lines.push("CALSCALE:GREGORIAN");
    lines.push("METHOD:PUBLISH");

    const dtstamp = icsNowStamp();

    items.forEach((it, idx) => {
      const uid = `${period}-${idx}-${Math.random().toString(16).slice(2)}@budgetwise`;
      const dt = it.dateISO.replaceAll("-", ""); // YYYYMMDD (all-day)

      lines.push("BEGIN:VEVENT");
      lines.push(`UID:${uid}`);
      lines.push(`DTSTAMP:${dtstamp}`);
      lines.push(`SUMMARY:${icsEscape(it.title)}`);
      if (it.desc) lines.push(`DESCRIPTION:${icsEscape(it.desc)}`);
      lines.push(`DTSTART;VALUE=DATE:${dt}`);
      lines.push(`DTEND;VALUE=DATE:${addOneDayYYYYMMDD(dt)}`); // DTEND esclusivo
      lines.push("END:VEVENT");
    });

    lines.push("END:VCALENDAR");
    return lines.join("\r\n");
  }

  function icsNowStamp(){
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`;
  }

  function addOneDayYYYYMMDD(yyyymmdd){
    const y = Number(yyyymmdd.slice(0,4));
    const m = Number(yyyymmdd.slice(4,6));
    const d = Number(yyyymmdd.slice(6,8));
    const dt = new Date(y, m-1, d);
    dt.setDate(dt.getDate()+1);
    const pad = (n)=>String(n).padStart(2,"0");
    return `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}`;
  }

  function icsEscape(s){
    return String(s)
      .replaceAll("\\", "\\\\")
      .replaceAll("\n", "\\n")
      .replaceAll(",", "\\,")
      .replaceAll(";", "\\;");
  }

  function downloadText(text, filename, mime){
    const blob = new Blob([text], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  // =========================
  // [/GC]
  // =========================

})();
</script>
</body>
</html>

